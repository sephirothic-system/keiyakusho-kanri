# ディレクトリ内契約書一覧機能

## 概要

指定されたディレクトリ内の契約書を一覧表示し、検索・ページネーション機能を提供する機能を実装しました。

## 実装されたファイル

### API エンドポイント
- `app/api/directories/[id]/contracts/route.ts`
  - ディレクトリ内の契約書を取得するAPI
  - ページネーション、検索、ソート機能を提供

### UI コンポーネント
- `app/directories/[id]/contracts/page.tsx`
  - ディレクトリ内契約書一覧を表示するページコンポーネント
  - 検索機能、ページネーション機能を含む

### テストファイル
- `test/api/directories/[id]/contracts.test.ts` - APIのユニットテスト
- `test/app/directories/[id]/contracts/page.test.tsx` - UIコンポーネントのテスト
- `test/e2e/directory-contracts.spec.ts` - E2Eテスト

## 機能仕様

### API仕様（`GET /api/directories/[id]/contracts`）

#### クエリパラメータ
- `page` (optional): ページ番号（デフォルト: 1）
- `limit` (optional): 1ページあたりの件数（デフォルト: 10、最大: 100）
- `search` (optional): 契約書名の部分一致検索文字列

#### レスポンス形式
```json
{
  "contracts": [
    {
      "id": "string",
      "title": "string",
      "status": "DRAFT|REVIEW|ACTIVE|EXPIRED|TERMINATED",
      "contractNumber": "string|null",
      "startDate": "string|null",
      "endDate": "string|null",
      "createdAt": "string",
      "updatedAt": "string",
      "owner": {
        "id": "string",
        "name": "string|null",
        "email": "string"
      },
      "category": {
        "id": "string",
        "name": "string",
        "color": "string|null"
      } | null
    }
  ],
  "directory": {
    "id": "string",
    "name": "string",
    "path": "string",
    "description": "string|null"
  },
  "pagination": {
    "page": "number",
    "limit": "number",
    "totalCount": "number",
    "totalPages": "number",
    "hasNextPage": "boolean",
    "hasPreviousPage": "boolean"
  },
  "search": "string"
}
```

#### エラー処理
- 400: ページネーションパラメータが不正
- 404: 指定されたディレクトリが存在しない
- 500: サーバーエラー

### UI機能

#### 表示機能
- ディレクトリ情報の表示（名前、説明、パス）
- 契約書一覧の表示（新しい順でソート）
- 契約書の詳細情報表示
  - タイトル
  - ステータス（日本語表示）
  - 契約番号
  - 作成者情報
  - カテゴリ情報（色付きバッジ）
  - 作成日時、開始日、終了日

#### 検索機能
- 契約書名での部分一致検索（大文字小文字を区別しない）
- 検索結果のリアルタイム表示
- 検索条件クリア機能
- URLパラメータでの検索条件保持

#### ページネーション機能
- ページ番号表示（現在のページ周辺のページ番号を表示）
- 前へ/次へボタン
- ページ番号の直接クリック
- URLパラメータでのページ状態保持
- 省略表示（...）による大量ページの効率的な表示

#### ナビゲーション機能
- ディレクトリ一覧ページへの戻りリンク
- 契約書詳細ページへの遷移（契約書クリック）

#### 状態管理
- ローディング状態の表示
- エラー状態の表示（トースト通知）
- 空の状態の表示（契約書なし、検索結果なし）

## 技術的特徴

### データベースクエリ最適化
- Prisma を使用した効率的なクエリ
- 必要な関連データ（owner, category）のみを取得
- インデックスを活用したソート・検索

### フロントエンド最適化
- React Hooks を使用した状態管理
- useSearchParams による URL状態との同期
- 適切なローディング・エラー処理

### レスポンシブデザイン
- Tailwind CSS を使用したモダンなUI
- モバイル対応
- アクセシブルなコンポーネント設計

## テスト戦略

### APIテスト（`test/api/directories/[id]/contracts.test.ts`）
- ✅ 正常な契約書一覧取得
- ✅ ページネーション機能
- ✅ 検索機能（部分一致、大文字小文字無視）
- ✅ 検索とページネーションの組み合わせ
- ✅ エラーハンドリング（404、400）
- ✅ 関連データの正確な取得
- ✅ ソート機能（新しい順）
- ✅ 空のディレクトリ処理

### UIコンポーネントテスト（`test/app/directories/[id]/contracts/page.test.tsx`）
- ✅ コンポーネントの正常なレンダリング
- ✅ 契約書一覧の表示
- ✅ 検索機能の動作
- ✅ ページネーション機能
- ✅ ナビゲーション機能
- ✅ エラー処理
- ✅ 空の状態表示
- ✅ URLパラメータとの同期

### E2Eテスト（`test/e2e/directory-contracts.spec.ts`）
- ✅ エンドツーエンドの契約書一覧表示
- ✅ 検索機能の実動作
- ✅ ページネーション機能の実動作
- ✅ 検索とページネーションの組み合わせ
- ✅ ナビゲーション機能
- ✅ エラー状態の表示
- ✅ URLパラメータでの直接アクセス

## パフォーマンス考慮事項

### データベース
- インデックス活用によるクエリ最適化
- 必要なデータのみの取得（select指定）
- ページネーションによるメモリ使用量制御

### フロントエンド
- 不要な再レンダリングの防止
- 適切な依存配列の設定
- ローディング状態の適切な表示

## セキュリティ考慮事項

### 入力値検証
- ページネーションパラメータの範囲チェック
- SQLインジェクション対策（Prismaの活用）
- XSS対策（適切なエスケープ）

### アクセス制御
- ディレクトリの存在確認
- 将来的な権限チェックへの拡張対応

## 今後の拡張可能性

### 機能拡張
- フィルタリング機能（ステータス、カテゴリ、作成者）
- ソート順の変更（タイトル順、更新日順など）
- エクスポート機能
- バルク操作

### 技術的改善
- 仮想スクロールによる大量データ対応
- キャッシュ機能の実装
- プリフェッチによる UX 向上

## 使用方法

### 基本的な使用方法
1. ディレクトリ管理画面からディレクトリを選択
2. `/directories/{directoryId}/contracts` にアクセス
3. 契約書一覧が表示される

### 検索機能の使用
1. 検索バーに契約書名の一部を入力
2. 「検索」ボタンをクリック
3. 検索結果が表示される
4. 「クリア」ボタンで検索条件をリセット

### ページネーション機能の使用
1. 契約書が10件を超える場合、ページネーションが表示される
2. 「前へ」「次へ」ボタンまたはページ番号をクリック
3. URLパラメータでページ状態が保持される

## 実装のポイント

### 新しい順ソート
契約書は `createdAt` フィールドを基準に降順（新しい順）でソートされます。

### 検索機能
PostgreSQL の `ILIKE` 機能を活用し、大文字小文字を区別しない部分一致検索を実現しています。

### ページネーション
効率的なページネーションのため、`COUNT` クエリと `LIMIT/OFFSET` を使用し、不要なデータの取得を避けています。

### エラーハンドリング
適切なHTTPステータスコードとエラーメッセージを返し、フロントエンドでユーザーフレンドリーな表示を行います。

### テストの網羅性
API、UI、E2E の3層でテストを実装し、機能の品質を保証しています。

この実装により、ユーザーは効率的にディレクトリ内の契約書を管理・検索できるようになります。
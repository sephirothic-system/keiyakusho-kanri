# 権限管理機能

## 概要

トップページから権限管理画面に遷移できるようにし、ディレクトリアクセス権限の管理を行える機能を実装しました。

## 実装されたファイル

### UI コンポーネント
- `app/permissions/page.tsx`
  - 権限管理専用のページコンポーネント
  - ディレクトリアクセス権限の表示・追加・更新・削除機能

### API エンドポイント
- `app/api/permissions/directory-access/route.ts`
  - ディレクトリアクセス権限の一覧取得・作成API
- `app/api/permissions/directory-access/[id]/route.ts`
  - 個別のディレクトリアクセス権限の更新・削除API

### 既存ファイルの変更
- `app/page.tsx`
  - トップページに権限管理へのナビゲーションを追加
  - 「権限を管理」クイックアクションカードを追加

### テストファイル
- `test/api/permissions/directory-access.test.ts`
  - 権限管理APIの包括的なテスト

## 機能仕様

### 権限管理画面の機能

#### 基本機能
- **ディレクトリアクセス権限の一覧表示**
  - 現在設定されているすべてのアクセス権限を表示
  - ディレクトリパス順、グループ名順でソート
  - 権限レベル（読み取り/書き込み）を色分け表示

#### アクセス権限の追加
- **ディレクトリ選択**: 既存のディレクトリから選択
- **グループ選択**: 既存のグループから選択（メンバー数も表示）
- **権限レベル選択**: 読み取り（READ）または書き込み（WRITE）
- **重複チェック**: 同じディレクトリ・グループの組み合わせの重複を防止

#### アクセス権限の管理
- **権限変更**: ドロップダウンから権限レベルを変更
- **権限削除**: 確認ダイアログ付きで権限を削除
- **リアルタイム更新**: 変更後即座に画面に反映

#### グループ概要表示
- 登録されているグループの一覧
- 各グループのメンバー数表示
- クリックでグループ管理画面に遷移

#### ナビゲーション
- **ホームへの戻り**: トップページへの戻りリンク
- **関連機能へのリンク**: グループ管理、ディレクトリ管理へのリンク

### API仕様

#### `GET /api/permissions/directory-access`
ディレクトリアクセス権限一覧の取得

**レスポンス例:**
```json
{
  "directoryAccess": [
    {
      "id": "access-id",
      "permission": "WRITE",
      "createdAt": "2024-01-01T00:00:00Z",
      "directory": {
        "id": "dir-id",
        "name": "法務部",
        "path": "/legal",
        "description": "法務部専用ディレクトリ"
      },
      "group": {
        "id": "group-id",
        "name": "法務チーム",
        "description": "法務部のメンバー",
        "_count": {
          "userGroups": 5
        }
      }
    }
  ]
}
```

#### `POST /api/permissions/directory-access`
新しいディレクトリアクセス権限の作成

**リクエストボディ:**
```json
{
  "directoryId": "directory-id",
  "groupId": "group-id",
  "permission": "READ" | "WRITE"
}
```

#### `PUT /api/permissions/directory-access/[id]`
既存のディレクトリアクセス権限の更新

**リクエストボディ:**
```json
{
  "permission": "READ" | "WRITE"
}
```

#### `DELETE /api/permissions/directory-access/[id]`
ディレクトリアクセス権限の削除

### トップページの変更

#### クイックアクション追加
- **「権限を管理」カード**を追加
- Shield アイコンで視覚的に識別
- 「ディレクトリのアクセス権限を設定・管理」の説明文
- クリックで `/permissions` に遷移

#### レスポンシブ対応
- グリッドレイアウトを `lg:grid-cols-3` から `lg:grid-cols-4` に変更
- 4つのクイックアクションカードが適切に配置

## 技術的特徴

### データベース連携
- **Prisma ORM**を使用した型安全なデータベース操作
- **トランザクション処理**による一貫性の保証
- **関連データの効率的な取得**（include/select最適化）

### バリデーション
- **フロントエンド**: 必須項目の入力チェック
- **バックエンド**: 型検証、存在確認、重複チェック
- **ユーザーフレンドリー**: 分かりやすいエラーメッセージ

### UI/UX設計
- **直感的なインターフェース**: ドロップダウンとボタンによる操作
- **視覚的フィードバック**: 権限レベルの色分け表示
- **確認ダイアログ**: 削除操作での誤操作防止
- **レスポンシブデザイン**: デスクトップ・タブレット・モバイル対応

### エラーハンドリング
- **包括的なエラー処理**: 想定されるすべてのエラーケースに対応
- **適切なHTTPステータス**: 400、404、500エラーの使い分け
- **ユーザー通知**: Toast通知による操作結果の表示

## テスト戦略

### APIテスト（15のテストケース）
- ✅ 権限一覧の正常取得
- ✅ 権限の正常作成
- ✅ 権限の正常更新
- ✅ 権限の正常削除
- ✅ バリデーションエラー（必須項目、無効な値）
- ✅ 存在確認エラー（存在しないディレクトリ・グループ）
- ✅ 重複エラー（既存の権限設定）
- ✅ 権限が存在しない場合の空配列返却

### データ整合性テスト
- ディレクトリ・グループの存在確認
- 権限の重複防止
- データベース制約の確認
- トランザクション処理の検証

## セキュリティ考慮事項

### 入力値検証
- **権限値の検証**: READ/WRITE以外の値を拒否
- **IDの検証**: 存在しないIDへのアクセスを防止
- **SQLインジェクション対策**: Prisma ORMによる安全なクエリ

### アクセス制御
- **認証チェック**: 将来的な認証機能との連携準備
- **権限チェック**: 管理者権限の確認（将来実装予定）

## パフォーマンス最適化

### データベースクエリ
- **必要なデータのみ取得**: selectによる最適化
- **関連データの一括取得**: N+1問題の回避
- **ソート処理**: データベースレベルでのソート

### フロントエンド
- **状態管理の最適化**: 必要な時のみAPIコール
- **UI応答性**: 操作に対する即座のフィードバック

## 今後の拡張可能性

### 機能拡張
- **権限の継承**: 親ディレクトリからの権限継承
- **詳細権限**: 読み取り、書き込み、削除、管理の細分化
- **期限付き権限**: 有効期限を持つアクセス権限
- **権限テンプレート**: よく使用される権限設定のテンプレート化

### UI/UX改善
- **バルク操作**: 複数の権限を一括で設定・変更
- **権限マトリックス**: グループ×ディレクトリの一覧表示
- **検索・フィルタ**: 大量の権限設定での検索機能
- **権限履歴**: 権限変更の履歴表示

### セキュリティ強化
- **監査ログ**: 権限変更の詳細ログ記録
- **承認フロー**: 権限変更の承認プロセス
- **自動権限管理**: ユーザーの所属変更時の自動権限調整

## 使用方法

### 基本的な権限設定
1. トップページの「権限を管理」をクリック
2. 「新しいアクセス権限を追加」でディレクトリとグループを選択
3. 権限レベル（読み取り/書き込み）を選択
4. 「追加」ボタンで権限を設定

### 権限の変更・削除
1. 権限管理画面で設定済みの権限を確認
2. 権限レベル変更：ドロップダウンから新しい権限を選択
3. 権限削除：ゴミ箱アイコンをクリックして確認

### 関連機能への遷移
- **グループ管理**：メンバーの追加・削除
- **ディレクトリ管理**：ディレクトリの作成・編集
- **グループ概要**：クリックでグループ管理画面に遷移

## 開発者向け情報

### コードの構成
- **型安全性**: TypeScriptによる厳密な型定義
- **関数型アプローチ**: 純粋関数による予測可能な動作
- **コンポーネント分離**: 再利用可能なUIコンポーネント

### 保守性の配慮
- **明確な関数名**: 意図が伝わりやすい命名
- **適切なコメント**: なぜその実装にしたかの説明
- **テストの充実**: 変更に対する安全性の確保

この実装により、管理者は直感的なUIでディレクトリアクセス権限を効率的に管理できるようになります。また、堅牢なテストとセキュリティ対策により、企業レベルでの運用に対応できる品質を確保しています。